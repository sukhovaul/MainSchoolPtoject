{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="lesson-header text-center mb-5">
                <h1 class="display-5 font-weight-bold text-primary">
                    <i class="fas fa-{{ lesson_icon }} mr-3"></i>
                    {{ lesson_title }}
                </h1>
                <p class="lead text-muted">{{ lesson_description }}</p>
                
                <div class="progress-info">
                    <span class="badge badge-primary">Задание {{ current_question }}/{{ total_questions }}</span>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar" style="width: {{ (current_question / total_questions * 100) }}%"></div>
                    </div>
                </div>
            </div>

            <div class="gesture-card text-center mb-4">
                {% block gesture_content %}{% endblock %}
            </div>

            <div class="question-card">
                {% block question_content %}{% endblock %}
            </div>

            <div class="lesson-navigation mt-5">
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-outline-primary btn-lg" onclick="window.location.href='/lessons'">
                            <i class="fas fa-arrow-left mr-2"></i>К урокам
                        </button>
                    </div>
                    <div class="col-6 text-right">
                        {% block next_button %}
                        <button class="btn btn-primary btn-lg" id="nextBtn" disabled onclick="goToNextQuestion()">
                            {% if current_question == total_questions %}
                            Завершить и вернуться к урокам
                            {% else %}
                            Следующий вопрос
                            {% endif %}
                        </button>
                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.answer-option {
    border: 2px solid #e8f4ff;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.answer-option:hover {
    border-color: #1E6FA8;
    background-color: #f8f9fa;
}

.answer-option.correct {
    border-color: #28a745;
    background-color: #d4edda;
    color: #155724;
}

.answer-option.incorrect {
    border-color: #dc3545;
    background-color: #f8d7da;
    color: #721c24;
}

.answer-option.disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

#nextBtn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}
</style>
<script>
let answered = false;

function selectAnswer(element, isCorrect) {
    if (answered) return;
    
    answered = true;
    
    // Получаем текст выбранного ответа
    const selectedText = element.querySelector('h5')?.textContent || element.textContent;
    
    // Блокируем все варианты
    const allOptions = document.querySelectorAll('.answer-option');
    allOptions.forEach(opt => {
        opt.style.pointerEvents = 'none';
        opt.classList.add('disabled');
    });
    
    // Активируем кнопку
    document.getElementById('nextBtn').disabled = false;
    
    if (isCorrect) {
        element.classList.add('correct');
        saveAnswer(true, selectedText);
    } else {
        element.classList.add('incorrect');
        
        // Находим правильный ответ
        allOptions.forEach(opt => {
            if (opt.getAttribute('data-is-correct') === 'true') {
                opt.classList.add('correct');
            }
        });
        
        saveAnswer(false, selectedText);
    }
}

function saveAnswer(isCorrect, selectedAnswer) {
    // Отправляем ответ на сервер
    fetch('/save_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lesson_id: {{ lesson_id }},
            gesture_id: {{ current_gesture.gesture_id }},
            is_correct: isCorrect,
            selected_answer: selectedAnswer  // Отправляем выбранный ответ
        })
    }).then(response => response.json())
    .then(data => {
        console.log('Ответ сохранен:', data);
    }).catch(error => {
        console.error('Ошибка при сохранении ответа:', error);
    });
}

function goToNextQuestion() {
    // Если это последний вопрос
    {% if current_question == total_questions %}
        // Переходим на страницу завершения урока
        window.location.href = "/finish_lesson/{{ lesson_id }}";
    {% else %}
        window.location.href = "{{ next_question_url }}";
    {% endif %}
}

// Разрешаем Enter для перехода
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !document.getElementById('nextBtn').disabled) {
        goToNextQuestion();
    }
});
</script>
{% endblock %}