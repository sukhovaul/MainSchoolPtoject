{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/lessons">Уроки</a></li>
                    <li class="breadcrumb-item"><a href="#">{{ module_title }}</a></li>
                    <li class="breadcrumb-item active">{{ lesson_title }}</li>
                </ol>
            </nav>

            <div class="lesson-header text-center mb-5">
                <h1 class="display-5 font-weight-bold text-primary">
                    <i class="fas fa-{{ lesson_icon }} mr-3"></i>
                    {{ lesson_title }}
                </h1>
                <p class="lead text-muted">{{ lesson_description }}</p>
                
                <div class="progress-info">
                    <span class="badge badge-primary">Задание {{ current_question }}/{{ total_questions }}</span>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar" style="width: {{ (current_question / total_questions * 100) }}%"></div>
                    </div>
                </div>
            </div>

            <div class="gesture-card text-center mb-4">
                {% block gesture_content %}{% endblock %}
            </div>

            <div class="question-card">
                {% block question_content %}{% endblock %}
            </div>

            <div class="lesson-navigation mt-5">
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-outline-primary btn-lg" onclick="history.back()">
                            <i class="fas fa-arrow-left mr-2"></i>Назад
                        </button>
                    </div>
                    <div class="col-6 text-right">
                        {% block next_button %}
                        <button class="btn btn-primary btn-lg" id="nextBtn" disabled onclick="goToNextQuestion()">
                            {% if current_question == total_questions %}
                            Завершить урок
                            {% else %}
                            Следующий вопрос
                            {% endif %}
                        </button>
                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.answer-option {
    border: 2px solid #e8f4ff;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.answer-option:hover {
    border-color: #1E6FA8;
    background-color: #f8f9fa;
}

.answer-option.correct {
    border-color: #28a745;
    background-color: #d4edda;
    color: #155724;
}

.answer-option.incorrect {
    border-color: #6c757d;
    background-color: #6c757d;
    color: white;
    cursor: not-allowed;
}

.answer-option.disabled {
    cursor: not-allowed;
    opacity: 0.6;
    pointer-events: none;
}

#nextBtn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}
</style>

<script>
let answered = false;

function selectAnswer(element, isCorrect) {
    if (answered) return;
    
    answered = true;
    
    // Блокируем все варианты
    const allOptions = document.querySelectorAll('.answer-option');
    allOptions.forEach(opt => {
        opt.style.pointerEvents = 'none';
        opt.classList.add('disabled');
    });
    
    // Активируем кнопку "Следующий вопрос" ВСЕГДА, независимо от правильности ответа
    document.getElementById('nextBtn').disabled = false;
    
    if (isCorrect) {
        // Правильный ответ
        element.classList.add('correct');
    } else {
        // Неправильный ответ
        element.classList.add('incorrect');
        
        // Находим и подсвечиваем правильный ответ
        allOptions.forEach(opt => {
            if (opt.getAttribute('data-correct') === 'true') {
                opt.classList.add('correct');
            }
        });
    }
}

function goToNextQuestion() {
    {% if next_question_url %}
    window.location.href = "{{ next_question_url }}";
    {% endif %}
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Проставляем data-атрибуты для правильных ответов
    const options = document.querySelectorAll('.answer-option');
    options.forEach(option => {
        const isCorrect = option.getAttribute('data-is-correct') === 'true';
        if (isCorrect) {
            option.setAttribute('data-correct', 'true');
        }
    });
});

// Разрешаем нажатие Enter для перехода к следующему вопросу
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !document.getElementById('nextBtn').disabled) {
        goToNextQuestion();
    }
});
</script>
{% endblock %}